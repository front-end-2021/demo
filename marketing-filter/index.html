<head>
    <link rel="stylesheet" href="3rd/bootstrap.min.css" />
    <link rel="stylesheet" href="3rd/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="3rd/default-ocean-blue.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="3rd/jquery-3.4.1.min.js"></script>
    <script src="3rd/kendo.all.min.js"></script>

    <script src="mock-data.js"></script>
    <script src="modal.js"></script>
</head>

<body>
    <section id="mFilter">
        <div class="list-criterial">

        </div>
        <div class="list-button">
            <button type="button" class="btn btn-primary">
                <i class="bi bi-search"></i> Filter</button>
            <button type="button" class="btn btn-secondary"><i class="bi bi-arrow-repeat">
                </i> Reset</button>
            <button type="button" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Add</button>
            <button type="button" class="btn btn-primary">
                <i class="bi bi-download"></i> Save filter</button>

        </div>
    </section>
    <script>

        $(document).ready(function () {
            const $mFilter = $('#mFilter')
            const $lstCrite = $mFilter.find('.list-criterial')
            for (let ii = 0; ii < mFilter.Blocks.length; ii++) {
                const row = mFilter.Blocks[ii]
                // {Operand, Type, Ids}
                let tRow = `<div class="m-criterial_${ii} cri-wrap">
                    <input class="mOperand" style="width: 96px;" />
                    <input class="mType" style="width: 240px;"/>
                </div>`
                $lstCrite.append(tRow)

                const $operand = $lstCrite.find('.mOperand')
                $operand.kendoDropDownList({
                    dataTextField: "Name",
                    dataValueField: "Id",
                    dataSource: ii > 0 ? Operands : [mFilterBy],
                    enable: ii < 1 ? false : true,
                    value: row.Operand,
                    change: function (e) {
                        const value = this.value()
                        row.Operand = parseInt(value)
                    }
                })

                const $type = $lstCrite.find('.mType')
                $type.kendoDropDownList({
                    dataTextField: "Name",
                    dataValueField: "Id",
                    dataSource: mType,
                    value: row.Type,
                    change: function (e) {
                        const tType = this.value()
                        row.Type = parseInt(tType)

                        const control = mFilter.Controls[ii]
                        const ctlIds = control.Ids
                        for (let kk = ctlIds.length - 1; -1 < kk; kk--) {
                            const $cId = ctlIds[kk]
                            $cId.data("kendoDropDownList").destroy()
                            $cId.closest('.k-dropdownlist.fcsub').remove()
                            ctlIds.splice(kk, 1)
                        }
                        row.Ids = getInitIds(row.Type)

                        const $tRow = e.sender.element.closest('.cri-wrap')
                        control.Ids = renderIdsDropdownList.call($tRow, row)
                    }
                })

                let cIds = []
                if (row.Ids.length) {
                    const $tRow = $lstCrite.find(`.m-criterial_${ii}`)
                    cIds = renderIdsDropdownList.call($tRow, row)
                }
                mFilter.Controls.push({
                    Operand: $operand, Type: $type, Ids: cIds
                })
            }
        })
        function renderIdsDropdownList(crite) {
            const $tRow = this
            const cIds = []
            if (!Array.isArray(crite.Ids)) return cIds
            let tInput = ``
            for (let jj = 0; jj < crite.Ids.length; jj++) {
                tInput = `<input class="f-sub-${jj} fcsub" style="width: 240px;" />`
                $tRow.append(tInput)
            }

            for (let jj = 0; jj < crite.Ids.length; jj++) {
                const _id = crite.Ids[jj]
                const $input = $tRow.find(`.f-sub-${jj}`)
                $input.kendoDropDownList({
                    dataTextField: "Name",
                    dataValueField: "Id",
                    dataSource: getSourceIds(crite, jj),
                    value: _id,
                    change: function (e) {
                        const id = parseInt(this.value())
                        crite.Ids[jj] = id
                        if (jj < crite.Ids.length - 1) {
                            const initIds = getInitIds(crite.Type)
                            for (let kk = jj + 1; kk < crite.Ids.length; kk++) {
                                const nxtInitId = initIds[kk]
                                crite.Ids[kk] = nxtInitId
                                const nextCtrl = cIds[kk]
                                if (!nextCtrl) continue
                                const nxtDrp = nextCtrl.data("kendoDropDownList")
                                nxtDrp.value(nxtInitId)
                                nxtDrp.setDataSource(getSourceIds(crite, kk))
                                nxtDrp.refresh()
                            }
                        }

                    }
                })
                cIds.push($input)
            }
            return cIds
        }
    </script>
</body>