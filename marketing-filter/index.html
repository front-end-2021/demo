<head>
    <link rel="stylesheet" href="3rd/bootstrap.min.css" />
    <link rel="stylesheet" href="3rd/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="3rd/default-ocean-blue.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="3rd/jquery-3.4.1.min.js"></script>
    <script src="3rd/kendo.all.min.js"></script>

    <script src="common.js"></script>
    <script src="mock-data.js"></script>
    <script src="modal.js"></script>
</head>

<body>
    <main>
        <section id="mFilter">
            <div class="list-criterial"></div>
            <div class="list-button">
                <button type="button" class="btn btn-primary btnSetFilter"><i class="bi bi-search">
                    </i> Filter</button>
                <button type="button" class="btn btn-secondary"><i class="bi bi-arrow-repeat">
                    </i> Reset</button>
                <button type="button" class="btn btn-primary btnAddFilter">
                    <i class="bi bi-plus-circle"></i> Add</button>
                <button type="button" class="btn btn-primary">
                    <i class="bi bi-download"></i> Save filter</button>
            </div>
        </section>
        <article>
            <h6>View Goals: </h6>
            <div class="dnb_list-goal"></div>
        </article>
    </main>
    <section id="dashboard">
        <div class="list-land">
            <h6 onclick="toggleCollapse(this)">List Land: <b>&#10010;</b></h6>
        </div>
        <div class="list-region">
            <h6 onclick="toggleCollapse(this)">List Region: <b>&#10010;</b></h6>
        </div>
        <div class="list-productgroup">
            <h6 onclick="toggleCollapse(this)">List Product group: <b>&#10010;</b></h6>
        </div>
        <div class="list-product">
            <h6 onclick="toggleCollapse(this)">List Product: <b>&#10010;</b></h6>
        </div>
        <div class="list-subproduct">
            <h6 onclick="toggleCollapse(this)">List Sub product: <b>&#10010;</b></h6>
        </div>
        <div class="list-market">
            <h6 onclick="toggleCollapse(this)">List Market: <b>&#10010;</b></h6>
        </div>
        <div class="list-submarket">
            <h6 onclick="toggleCollapse(this)">List sub market: <b>&#10010;</b></h6>
        </div>
    </section>
    <script>
        let mktFilter
        $(document).ready(function () {
            const $mFilter = $('#mFilter')
            mktFilter = new mkFilter($mFilter, [new Criterial(0, 1, [0, 0])])

            const btnAddFilter = document.querySelector('#mFilter .btnAddFilter')
            btnAddFilter.addEventListener('click', (e) => mktFilter.addFilter())
            const btnSetFilter = document.querySelector('#mFilter .btnSetFilter')
            btnSetFilter.addEventListener('click', (e) => {
                renderGoals(mktFilter.GoalIds)
                renderDataRegions(mktFilter)
            })

            renderDashboard(document.querySelector(`#dashboard`))
            renderGoals(mktFilter.GoalIds)
            renderDataRegions(mktFilter)
        })
        function renderGoals(goalIds) {
            const goals = Goals.filter(x => goalIds.includes(x.Id))
            const $lstGoal = $('.dnb_list-goal')
            $lstGoal.html('')
            let row = ''
            for (let ii = 0; ii < goals.length; ii++) {
                const goal = goals[ii]
                row += `<div><span>${goal.Id}<span>
                    <span>${goal.Name}</span></div>`
            }
            $lstGoal.append(`<div>${row}</div>`)
            console.log(goals)
        }
        function renderDataRegions(filter) {
            const lstGoal = getGoals(filter.GoalIds)
            const lstLand = getLands(filter.LandIds)
            const lstRegion = getRegions(filter.RegionIds)
            const lstProductGrp = getProductGroups(filter.ProductIds)
            const lstSubmarketId = getSubmarketIds(filter.SubmarketIds, filter.LandIds)
            const lstPath = getPaths(lstLand, lstRegion)        // {IdLand, IdRegion, Path}
            console.log('List Land', lstLand)
            console.log('List Region', lstRegion)
            console.log('List Product group Products', lstProductGrp)
            console.log('List SubmarketId', lstSubmarketId)     // {IdLands, IdSubmarkets}
            console.log('List Goal', lstGoal)
            console.log('List original Path', JSON.parse(JSON.stringify(lstPath)))
            addProducts()
            console.log('List Path with Products', JSON.parse(JSON.stringify(lstPath)))
            addSubmarketIds()
            console.log('List Path with Products and IdSubmarkets', JSON.parse(JSON.stringify(lstPath)))
            addGoals()
            console.log('List Path with Goals', JSON.parse(JSON.stringify(lstPath)))

            function addGoals() {
                for (let ii = lstPath.length - 1; -1 < ii; ii--) {
                    const item = lstPath[ii]
                    const idSubmarkets = item.IdSubmarkets
                    let goals = lstGoal.filter(g => idSubmarkets.includes(g.SubmarketId))
                    if (!goals.length) {
                        lstPath.splice(ii, 1)
                        continue
                    }
                    const idProducts = item.Products.map(x => x.Id)
                    goals = goals.filter(g => idProducts.includes(g.ProductId))
                    if (!goals.length) {
                        lstPath.splice(ii, 1)
                        continue
                    }
                    for (let pd = 0; pd < item.Products.length; pd++) {
                        const product = item.Products[pd]
                        product.ListGoal = goals.map(x => { return { Id: x.Id, Name: x.Name } })
                    }
                }
            }
            function getGoals(goalIds) {
                const lstGoal = Goals.filter(x => goalIds.includes(x.Id))
                return lstGoal.map(g => {
                    const lstSmkPrdId = g.SubmarketProductId.split('-')
                    return {
                        Id: g.Id, Name: g.Name,
                        SubmarketId: parseInt(lstSmkPrdId[0]),
                        ProductId: parseInt(lstSmkPrdId[1])
                    }
                })
            }
            function addSubmarketIds() {
                for (let ii = lstPath.length - 1; -1 < ii; ii--) {
                    const item = lstPath[ii]
                    const submrkIds = lstSubmarketId.filter(x => x.IdLands.includes(item.IdLand))
                    if (!submrkIds.length) {
                        lstPath.splice(ii, 1)
                        continue
                    }
                    if (!Array.isArray(item.IdSubmarkets)) item.IdSubmarkets = []

                    submrkIds.forEach(itmSubmrkId => {
                        item.IdSubmarkets = [...item.IdSubmarkets, ...itmSubmrkId.IdSubmarkets]
                    })

                    item.IdSubmarkets.distinct()
                }
            }
            function addProducts() {
                for (let ii = lstPath.length - 1; -1 < ii; ii--) {
                    const item = lstPath[ii]
                    const prdGrp = lstProductGrp.find(x => x.RegionIds.includes(item.IdRegion))
                    if (!prdGrp) {
                        lstPath.splice(ii, 1)
                        continue
                    }
                    item.PGroupName = prdGrp.Name
                    item.Products = prdGrp.Products.map(x => { return { Id: x.Id, Name: x.Name } })
                }
            }
            function getPaths(lands, regns) {
                const lst = []
                for (let ii = 0; ii < regns.length; ii++) {
                    const regn = regns[ii]
                    const land = lands.find(x => x.Id == regn.LandId)
                    if (!land) continue
                    lst.push({
                        IdLand: regn.LandId, IdRegion: regn.Id,
                        Path: `${land.Name} > ${regn.Name}`
                    })
                }
                return lst
            }
            function getProductGroups(prdIds) {
                const lst = []
                let prdGrp = null
                for (let ii = 0; ii < Products.length; ii++) {
                    const prd = Products[ii]
                    if (!prdIds.includes(prd.Id)) continue
                    if (!prdGrp || prdGrp.Id != prd.PrgId) {
                        prdGrp = ProductGroups.find(x => x.Id == prd.PrgId)
                        lst.push({
                            Products: [prd],
                            RegionIds: prdGrp.RegionIds,
                            Name: prdGrp.Name,
                            Id: prdGrp.Id
                        })
                    } else {
                        const item = lst.find(x => x.Id == prdGrp.Id)
                        item.Products.push(prd)
                    }
                }
                return lst
            }
            function getLands(landIds) {
                const lst = []
                for (let ii = 0; ii < Lands.length; ii++) {
                    const land = Lands[ii]
                    if (landIds.includes(land.Id)) lst.push(land)
                }
                return lst
            }
            function getRegions(regnIds) {
                const lst = []
                for (let ii = 0; ii < Regions.length; ii++) {
                    const rgn = Regions[ii]
                    if (regnIds.includes(rgn.Id)) lst.push(rgn)
                }
                return lst
            }
            function getSubmarketIds(subMrkIds, landIds) {
                const lstsMrkId = [];
                let mrk;
                const submarkets = StakeholderGroups
                for (let ii = 0; ii < submarkets.length; ii++) {
                    const sMkr = submarkets[ii]
                    if (!subMrkIds.includes(sMkr.Id)) continue

                    if (!mrk || sMkr.MarketId != mrk.Id) {
                        mrk = MarketSegments.find(x => x.Id == sMkr.MarketId)
                        lstsMrkId.push({
                            IdMarket: mrk.Id,
                            IdLands: mrk.LandIds,
                            IdSubmarkets: [sMkr.Id]
                        })
                        continue
                    }
                    const lstItem = lstsMrkId.find(x => x.IdMarket == mrk.Id)
                    if (!lstItem) continue
                    lstItem.IdSubmarkets.push(sMkr.Id)
                }
                for (let ii = lstsMrkId.length - 1; -1 < ii; ii--) {
                    const mrkItem = lstsMrkId[ii]
                    if (!anyIds(landIds, mrkItem.IdLands)) {
                        lstsMrkId.splice(ii, 1)
                    }
                }
                return lstsMrkId
            }
            function anyIds(lstId1, lstId2) {
                for (let ii = 0; ii < lstId1.length; ii++) {
                    if (lstId2.includes(lstId1[ii])) return true
                }
                return false
            }
        }
        function renderDashboard(container) {
            const dLstLand = container.querySelector(`.list-land`)
            const dLstRegion = container.querySelector(`.list-region`)
            const dLstPrdGroup = container.querySelector(`.list-productgroup`)
            const dLstProduct = container.querySelector(`.list-product`)
            const dLstSubProduct = container.querySelector(`.list-subproduct`)
            const dLstMarket = container.querySelector(`.list-market`)
            const dLstSubMarket = container.querySelector(`.list-submarket`)

            renderLands()
            renderRegions()
            renderProductGroups()

            function renderProductGroups() {
                const $wrapLst = $(dLstPrdGroup)
                for (let ii = 0; ii < ProductGroups.length; ii++) {
                    const item = ProductGroups[ii]
                    $wrapLst.append(`<div class="lst-entry">
                        <span>${item.Id}</span>
                        <input type="text" class="form-control" value="${item.Name}"/>
                        <button type="button" class="btn btn-secondary">Update</button>
                        </div>`)
                }
            }
            function renderRegions() {
                const $wrapLst = $(dLstRegion)
                for (let ii = 0; ii < Regions.length; ii++) {
                    const item = Regions[ii]
                    $wrapLst.append(`<div class="lst-entry">
                        <span>${item.Id}</span>
                        <input type="text" class="form-control" value="${item.Name}"/>
                        <button type="button" class="btn btn-secondary">Update</button>
                        </div>`)
                }
            }
            function renderLands() {
                const $wrapLst = $(dLstLand)
                for (let ii = 0; ii < Lands.length; ii++) {
                    const item = Lands[ii]
                    $wrapLst.append(`<div class="lst-entry">
                        <span>${item.Id}</span>
                        <input type="text" class="form-control" value="${item.Name}"/>
                        <button type="button" class="btn btn-secondary">Update</button>
                        </div>`)
                }
            }
        }
        function toggleCollapse(e) {
            const container = e.closest(`[class|="list"]`)
            container.classList.toggle('dnb-collapse');
        }
    </script>
</body>