<head>
    <link rel="stylesheet" href="3rd/bootstrap.min.css" />
    <link rel="stylesheet" href="3rd/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="3rd/default-ocean-blue.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="3rd/jquery-3.4.1.min.js"></script>
    <script src="3rd/kendo.all.min.js"></script>

    <script src="mock-data.js"></script>
    <script src="modal.js"></script>
</head>

<body>
    <section id="mFilter">
        <div class="list-criterial">

        </div>
        <div class="list-button">
            <button type="button" class="btn btn-primary">
                <i class="bi bi-search"></i> Filter</button>
            <button type="button" class="btn btn-secondary"><i class="bi bi-arrow-repeat">
                </i> Reset</button>
            <button type="button" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Add</button>
            <button type="button" class="btn btn-primary">
                <i class="bi bi-download"></i> Save filter</button>
                
        </div>
    </section>
    <script>
        
        $(document).ready(function () {
            const $mFilter = $('#mFilter')
            const $lstCrite = $mFilter.find('.list-criterial')
            for(let ii = 0; ii < mFilter.Blocks.length; ii++) {
                const row = mFilter.Blocks[ii]
                // {Operand, Type, Ids}
                let tRow = `<div class="m-criterial_${ii} cri-wrap">
                    <input class="mOperand" style="width: 96px;" />
                    <input class="mType" style="width: 240px;"/>
                </div>`
                $lstCrite.append(tRow)

                const $operand = $lstCrite.find('.mOperand')
                $operand.kendoDropDownList({
                    dataTextField: "Name",
                    dataValueField: "Id",
                    dataSource: ii > 0 ? Operands : filterBy,
                    enable: ii < 1 ? false : true,
                    value: row.Operand,                    
                    change: function(e) {
                        const value = this.value()
                        row.Operand = parseInt(value)
                    }
                })
                
                const $type = $lstCrite.find('.mType')
                $type.kendoDropDownList({
                    dataTextField: "Name",
                    dataValueField: "Id",
                    dataSource: mType,
                    value: row.Type,
                    change: function(e) {
                        const value = this.value()
                        row.Type = parseInt(value)

                        const control = mFilter.Controls[ii]
                        const ctlIds = control.Ids
                        for(let kk = ctlIds.length - 1; -1 < kk; kk--) {
                            const $cId = ctlIds[kk]
                            $cId.data("kendoDropDownList").destroy()
                            $cId.closest('.k-dropdownlist.fcsub').remove()
                            ctlIds.splice(kk, 1)
                        }
                        row.Ids = getIds(row.Type)

                        const $tRow = e.sender.element.closest('.cri-wrap')
                        control.Ids = renderIdsDropdownList.call($tRow, row.Ids)
                    }
                })
                
                let cIds = []
                if(row.Ids.length) {
                    const $tRow = $lstCrite.find(`.m-criterial_${ii}`)
                    cIds = renderIdsDropdownList.call($tRow, row.Ids)
                }
                mFilter.Controls.push({
                    Operand: $operand, Type: $type, Ids: cIds
                })
            }
        })
        function renderIdsDropdownList(ids){
            const $tRow = this
            const cIds = []
            let tInput = ``
            for(let jj = 0; jj < ids.length; jj++) {
                tInput = `<input class="f-sub-${jj} fcsub" style="width: 240px;" />`
                $tRow.append(tInput)
            }
            
            for(let jj = 0; jj < ids.length; jj++) {
                const _id = ids[jj]
                const $input = $tRow.find(`.f-sub-${jj}`)
                $input.kendoDropDownList({
                    dataTextField: "Name",
                    dataValueField: "Id",
                    dataSource: lType,
                    value: _id,                    
                    change: function(e) {
                        
                    }
                })
                cIds.push($input)
            }
            return cIds
        }
    </script>
</body>